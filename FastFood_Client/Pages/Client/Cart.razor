@page "/cart"
@using Data.Models.ProductModels
@using FastFood_Client.HttpRepositories.Interfaces
@inject IHttpProductService HttpProductService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime // Inject JSRuntime

<PageTitle>Giỏ Hàng</PageTitle>
<!-- ... (Phần Breadcrumb như trước) ... -->
<!-- Shopping Cart Section Begin -->
<section class="shopping-cart spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <div class="shopping__cart__table">
                    <table>
                        <thead>
                            <tr>
                                <th>Sản Phẩm</th>
                                <th>Số Lượng</th>
                                <th>Thành Tiền</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (CartItems != null)
                            {
                                @foreach (var product in CartItems)
                                {
                                    <tr>
                                        <td class="product__cart__item">
                                            <div class="product__cart__item__pic">
                                                <img src="/client/img/shop/@product.Image" alt="">
                                            </div>
                                            <div class="product__cart__item__text">
                                                <h6>@product.ProductName</h6>
                                                <h5>$@product.Price.ToString("0.00")</h5>
                                            </div>
                                        </td>
                                        <td class="quantity__item">
                                            <div class="quantity">
                                                <div class="pro-qty">
                                                    <input type="text" @bind="quantity">
                                                </div>
                                            </div>
                                        </td>
                                        <td class="cart__price">$@(product.Price * quantity).ToString("0.00")</td>
                                        <td class="cart__close">
                                            <a href="#" @onclick="@(() => RemoveFromCart(product.Id))">
                                                <span class="icon_close"></span>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" class="text-center">Giỏ hàng trống</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <!-- ... (Phần continue__btn như trước) ... -->
            </div>
            <div class="col-lg-4">
                <!-- ... (Phần cart__discount và cart__total như trước) ... -->
            </div>
        </div>
    </div>
</section>
<!-- Shopping Cart Section End -->
<h1>Your Cart</h1>

@if (CartItems.Count == 0)
{
    <p>Your cart is empty.</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in CartItems)
            {
                <tr>
                    <td>@item.ProductName</td>
                    <td>$@item.Price.ToString("0.00")</td>
                    <td>
                        @* <input type="number" min="1" value="@item.Quantity" @onchange="() => UpdateQuantity(item, (int)Math.Max(1, double.Parse(Value)))"> *@
                    </td>
                    <td>$@(item.Price * item.Quantity).ToString("0.00")</td>
                    <td><button @onclick="() => RemoveFromCart(item)">Remove</button></td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr>
                <td colspan="4" class="text-right">Total:</td>
                <td>$@CartTotal.ToString("0.00")</td>
            </tr>
        </tfoot>
    </table>

    <button @onclick="Checkout" class="btn btn-primary">Checkout</button>
}

@code {
    private List<ProductForView> CartItems { get; set; } = new List<ProductForView>();
    private decimal TotalPrice { get; set; }

    private void CalculateCartTotal()
    {
        CartTotal = CartItems.Sum(item => item.Price * item.Quantity);
    }

    private async void UpdateQuantity(ProductForView item, int newQuantity)
    {
        var cartItem = CartItems.FirstOrDefault(i => i.Id == item.Id);
        if (cartItem != null)
        {
            cartItem.Quantity = newQuantity;

            // Update cart in local storage or session
            // (replace with your actual logic)
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "cart", System.Text.Json.JsonSerializer.Serialize(CartItems));

            CalculateCartTotal();
        }
    }

    private async void RemoveFromCart(ProductForView item)
    {
        TotalPrice = CartItems.Sum(p => p.Price * p.Quantity);
    }

        CalculateCartTotal();
    }

    private void Checkout()
    {
        // Implement checkout logic (e.g., redirect to payment page, handle API call)
        NavigationManager.NavigateTo("/checkout");
    }
}